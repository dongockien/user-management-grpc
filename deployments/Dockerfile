# Stage 1: Build - DÃ¹ng phiÃªn báº£n Go á»•n Ä‘á»‹nh
FROM golang:1.24-alpine AS builder

# CÃ i cÃ¡c cÃ´ng cá»¥ cáº§n thiáº¿t
RUN apk add --no-cache git build-base

WORKDIR /app

# Copy go.mod vÃ  go.sum, sau Ä‘Ã³ download dependencies
# Táº­n dá»¥ng Docker layer caching
COPY go.mod go.sum ./
RUN go mod download

# Copy toÃ n bá»™ code source
COPY . .

# Build a static binary Ä‘á»ƒ khÃ´ng phá»¥ thuá»™c C libraries trÃªn alpine
# ThÃªm -ldflags "-w -s" Ä‘á»ƒ giáº£m kÃ­ch thÆ°á»›c binary
RUN CGO_ENABLED=0 go build -a -ldflags "-w -s" -o user-grpc-app ./cmd/server

# Stage 2: Runtime - DÃ¹ng image tá»‘i giáº£n
FROM alpine:3.19

WORKDIR /app

# ğŸ”¹ Tá»I Æ¯U Báº¢O Máº¬T: Táº¡o má»™t user khÃ´ng cÃ³ quyá»n root
RUN addgroup -S appgroup && adduser -S appuser -G appgroup

# Copy binary Ä‘Ã£ build tá»« stage builder
COPY --from=builder /app/user-grpc-app .

# ğŸ”¹ Tá»I Æ¯U Báº¢O Máº¬T: XÃ³a dÃ²ng `COPY .env .`
# Cáº¥u hÃ¬nh sáº½ Ä‘Æ°á»£c truyá»n qua environment variables cá»§a Docker Compose

# Cáº¥p quyá»n cho user má»›i
RUN chown -R appuser:appgroup /app
USER appuser

# Expose cÃ¡c cá»•ng cáº§n thiáº¿t
EXPOSE 50051 8080 6060

# Lá»‡nh Ä‘á»ƒ cháº¡y á»©ng dá»¥ng
CMD ["./user-grpc-app"]